var dropzone,dropzoneZIP,editor;function resetCheckedbox(){$("#checkedAll:checked").prop("checked",false);$('#tbody-content input[type=checkbox][name="path[]"]:checked').prop("checked",false)}function refreshList(){if($("#tbody-content").length<1){window.location.reload();return}App.loading("show");$.get(window.location.href,{_pjax:"tbody-content"},function(e){var o=$(e);$("#tbody-content").html(o.find("#tbody-content").html());App.float("#tbody-content img.previewable");App.loading("hide");$("#tbody-content").trigger("refresh");resetCheckedbox()},"html")}function initCodeMirrorEditor(){editor=CodeMirror.fromTextArea($("#file-edit-content")[0],{lineNumbers:true,theme:"night",extraKeys:{F11:function(e){e.setOption("fullScreen",!e.getOption("fullScreen"))},Esc:function(e){if(e.getOption("fullScreen"))e.setOption("fullScreen",false)}}});editor.setOption("lineWrapping",true);editor.setSize("auto","auto");$("#file-edit-modal .modal-footer .btn-success").on("click",function(){var e=$(this).data("url");var o=$("#use-encoding-open").val();if(!o)o="";$.post(e,{content:editor.getValue(),encoding:o},function(e){if(e.Code!=1)return App.message({title:App.i18n.SYS_INFO,text:e.Info},false);return App.message({title:App.i18n.SYS_INFO,text:App.i18n.SAVE_SUCCEED},false)},"json")});$("#file-edit-modal .modal-body").css("padding",0);$("#use-encoding-open").on("change",function(){var e=$(this).val();fileReopen(e)})}function fileReopen(e,o){App.loading("show");if(o==null)o=$("#file-edit-modal .modal-footer .btn-success").data("url");$.get(o,{encoding:e},function(e){App.loading("hide");if(e.Code!=1)return App.message({title:App.i18n.SYS_INFO,text:e.Info},false);editor.setValue(e.Data)},"json")}function fileEdit(e,t){var o=$(e).data("url");$("#file-edit-modal .modal-footer .btn-success").data("url",o);App.loading("show");$.get(o,{},function(o){App.loading("hide");if(o.Code!=1)return App.message({title:App.i18n.SYS_INFO,text:o.Info},false);$("#file-edit-modal .modal-header h3").html(App.i18n.EDIT_FILE+": "+t);$("#file-edit-modal").niftyModal("show",{afterOpen:function(e){editor.setValue(o.Data);codeMirrorChangeMode(editor,t)},afterClose:function(e){$("#use-encoding-open").find("option:selected").prop("selected",false)}})},"json")}function fileRename(e,o,t){var i=$(e).data("url");$("#file-rename-modal .modal-footer .btn-primary:last").data("url",i);$("#file-rename-modal .modal-header h3").html((t?App.i18n.MODIFY_DIRNAME:App.i18n.MODIFY_FILENAME)+": "+o);$("#file-rename-modal").niftyModal("show",{afterOpen:function(e){$("#file-rename-input").val(o)}})}function fileMkdir(e){var o=$(e).data("url");$("#file-mkdir-modal .modal-footer .btn-primary:last").data("url",o);$("#file-mkdir-modal .modal-header h3").html(App.i18n.CREATE_DIR);$("#file-mkdir-modal").niftyModal("show",{afterOpen:function(e){$("#file-mkdir-input").val("");$("#file-mkdir-input").focus()}})}function filePlay(e,o){if(o==null)o="a[playable]";var t=$(e).data("url"),i=$(o).index($(e)),n=$(e).data("name"),l=$(e).data("mime"),d,a="file-play-video",r=$("#file-play-modal .modal-header h3");r.html(App.i18n.PLAY+": "+n);var p=$("#file-play-modal .modal-body");p.css({padding:"0","text-align":"center"});$(e).css({color:"yellow"});$("#file-play-modal").niftyModal("show",{afterOpen:function(e){$("#file-play-video source").attr("src",t).attr("type",l);$(window).trigger("resize");d=videojs(a,null,function(){this.on("ended",function(){i++;if(i>=$(o).length)i=0;var e=$(o).eq(i);e.css({color:"yellow"});this.src({type:e.data("mime"),src:e.data("url")});this.play();r.html(App.i18n.PLAY+": "+e.data("name"))})});d.play()},afterClose:function(){if(!d)return;var e=$('<video-js id="file-play-video" class="vjs-default-skin" width=500 height=500 controls><source src="" type=""></video-js>');d.dispose();d=null;p.html(e)}})}function codeMirrorChangeMode(e,o){var t,i,n;if(t=/.+\.([^.]+)$/.exec(o)){var l=CodeMirror.findModeByExtension(t[1]);if(l){i=l.mode;n=l.mime}}else if(/\//.test(o)){var l=CodeMirror.findModeByMIME(o);if(l){i=l.mode;n=o}}else{i=n=o}if(i){e.setOption("mode",n);CodeMirror.autoLoadMode(e,i)}else{console.log("Could not find a mode corresponding to "+o)}}Dropzone.autoDiscover=false;CodeMirror.modeURL=ASSETS_URL+"/js/editor/markdown/lib/codemirror/mode/%N/%N.js";function dropzoneResizeHeight(o){return function(){var e=o?"#multi-upload-zip-modal":"#multi-upload-modal";App.resizeModalHeight(e)}}$(function(){initDropzone($.extend({chunking:true,parallelChunkUploads:true,retryChunksLimit:5,retryChunks:true},window.dropzoneOptions||{}));dropzone=$("#multi-upload-dropzone").get(0).dropzone;dropzoneZIP=$("#multi-upload-zip-dropzone").length>0?$("#multi-upload-zip-dropzone").get(0).dropzone:null;dropzone.on("addedfiles",dropzoneResizeHeight(false));if(dropzoneZIP)dropzoneZIP.on("addedfiles",dropzoneResizeHeight(true));initCodeMirrorEditor();$("#uploadBtn").off().on("click",function(e){$("#multi-upload-modal").niftyModal("show",{closeOnClickOverlay:false,afterClose:function(e){dropzone.removeAllFiles();refreshList()}})});if($("#uploadZipBtn").length>0){$("#uploadZipBtn").off().on("click",function(e){$("#multi-upload-zip-modal").niftyModal("show",{closeOnClickOverlay:false,afterClose:function(e){if(dropzoneZIP)dropzoneZIP.removeAllFiles();refreshList()}})})}$(window).off().on("resize",function(){$("#file-edit-modal,#file-play-modal").css({height:$(window).height(),width:"100%","max-width":"100%",left:0,top:0,transform:"none"});$("#file-edit-form,#file-play-video").css({height:$(window).height()-150,width:"100%","max-width":"100%",overflow:"auto"});dropzoneResizeHeight(false)();if(dropzoneZIP)dropzoneResizeHeight(true)()});$(window).trigger("resize");$("#file-rename-modal .modal-footer .btn-primary:last").off().on("click",function(){var e=$(this).data("url");App.loading("show");$.post(e,{name:$("#file-rename-input").val()},function(e){App.loading("hide");if(e.Code!=1)return App.message({title:App.i18n.SYS_INFO,text:e.Info},false);App.message({title:App.i18n.SYS_INFO,text:App.i18n.SAVE_SUCCEED},false);refreshList()},"json")});$("#file-mkdir-modal .modal-footer .btn-primary:last").off().on("click",function(){var e=$(this).data("url");App.loading("show");$.post(e,{name:$("#file-mkdir-input").val()},function(e){App.loading("hide");if(e.Code!=1)return App.message({title:App.i18n.SYS_INFO,text:e.Info},false);App.message({title:App.i18n.SYS_INFO,text:App.i18n.CREATE_SUCCEED},false);refreshList()},"json")});$("#query-current-path").on("keyup",function(){var e=$(this).val();if(e==""){$("#tbody-content").children("tr:not(:visible)").show();var o=$('#tbody-content input[type=checkbox][name="path[]"]:disabled');if(o.length>0)$("#checkedAll").prop("checked",false);o.prop("disabled",false);return}$("#tbody-content").children('tr:not([item*="'+e+'"])').hide().find('input[type=checkbox][name="path[]"]').prop("disabled",true);$("#tbody-content").children('tr[item*="'+e+'"]:not(:visible)').show().find('input[type=checkbox][name="path[]"]:disabled').prop("disabled",false);$('#tbody-content input[type=checkbox][name="path[]"]:disabled:checked').prop("checked",false);$("#checkedAll").prop("checked",$('#tbody-content tr[item]:visible input[type=checkbox][name="path[]"]:checked').length==$('#tbody-content tr[item]:visible input[type=checkbox][name="path[]"]'));if(event.keyCode==13){var t=$("#tbody-content").children("tr:visible");if(t.length==1){var i=t.children("td:first").children("a:first");var n=i.attr("href");window.location=n;return}}}).focus();$("#btn-query-current-path").on("click",function(){$("#query-current-path").trigger("keyup")});App.float("#tbody-content img.previewable");resetCheckedbox();App.attachCheckedAll("#checkedAll",'#tbody-content input[type=checkbox][name="path[]"]')});