function FormatProgressBar(e){var o=parseInt(e);var n='<div class="progress"><div class="progress-bar" style="width: '+o+'%"></div></div>';return n}function FormatBytes(e){var o=parseInt(e);return App.formatBytes(o)}function StateIcon(e){var o,n;switch(e){case"Completed":o="ok-circle text-success";break;case"Running":o="play-circle text-info";break;case"Stopped":o="ban-circle text-warning";break;case"Failed":o="remove-circle text-danger";break;default:e="Stopped";o="ban-circle text-warning"}n=states[e];return'<span class="glyphicon glyphicon-'+o+'" title="'+n+'"></span>'}function FormatSpeedBytes(e){return FormatBytes(e)+"/s"}var downloadWS,downloadWSInterval,downloadAPIPrefix=BACKEND_URL+"/download";function connectSockJS(e,o){if(downloadWS){if(e!=null)e();return false}downloadWS=new SockJS(downloadAPIPrefix+"/progress");downloadWS.onopen=function(){if(e!=null)e()};downloadWS.onclose=function(){downloadWS=null};downloadWS.onmessage=function(e){if(o!=null)o(e.data)}}function closeSockJS(){if(downloadWSInterval){window.clearInterval(downloadWSInterval);downloadWSInterval=null}if(downloadWS){downloadWS.close();downloadWS=null}}function sockJSConnect(){var f=$("#tr-template").html();connectSockJS(function(){downloadWS.send("progress")},function(e){var o=JSON.parse(e);var n=100*o.length,a=0;var t=$("#fileTable .allCheck").prop("checked");for(var r=0;r<o.length;r++){var l=o[r];if(l.State!="Running"){a+=100}else{a+=l.Progress}if($("#id-"+l.Id).length>0){$("#downed-"+l.Id).text(FormatBytes(l.Downloaded));$("#percent-"+l.Id).text(l.Progress);$("#speed-"+l.Id).text(FormatSpeedBytes(l.Speed));$("#progress-"+l.Id).html(FormatProgressBar(l.Progress));$("#state-"+l.Id).html(StateIcon(l.State));continue}var s=f;for(var i in l){var d=new RegExp("\\{"+i+"\\}","g");var c=l[i];switch(i){case"Downloaded":c=FormatBytes(c);break;case"Size":c=c=="-1"?"unknown":FormatBytes(c);break;case"Speed":c=FormatSpeedBytes(c);break;case"FileName":c='<span id="state-'+l.Id+'">'+StateIcon(l.State)+"</span> "+c;break;case"Progress":var p=new RegExp("\\{Percent\\}");s=s.replace(p,c);c=FormatProgressBar(c);break}s=s.replace(d,c)}if(t){s=$(s);s.find(".idCheck").prop("checked",true)}$("#fileList").append(s)}if(downloadWSInterval&&n<=a){closeSockJS()}})}function sockJSRead(){if(downloadWSInterval)return;if(!downloadWS){sockJSConnect()}else{downloadWS.send("progress")}downloadWSInterval=setInterval(function(){if(!downloadWS){window.clearInterval(downloadWSInterval);return}downloadWS.send("progress")},2e3)}function reqJSON(e,o,n){loading(false);var a={contentType:"application/json; charset=utf-8",url:downloadAPIPrefix+e,type:"POST",dataType:"json"};if(o)a.data=JSON.stringify(o);$.ajax(a).error(function(e){loading(true);console.dir(e)}).success(function(e){loading(true);if(e.Code!=1){App.message({text:e.Info,type:"error"},false);return}if(n)n();sockJSRead()})}function reqForm(e,o,n){loading(false);var a={url:downloadAPIPrefix+e,type:"POST",dataType:"json"};if(o)a.data=o;$.ajax(a).error(function(e){loading(true);alert(e)}).success(function(e){loading(true);if(e.Code!=1){App.message({text:e.Info,type:"error"},false);return}if(n)n();sockJSRead()})}function AddDownload(){var e={PartCount:parseInt($("#part_count_id").val()),FilePath:$("#save_path_id").val(),Url:$("#url_id").val()};e.Pipes=[];$('#select-option-pipes input[name="pipes[]"]:checked').each(function(){e.Pipes.push($(this).val())});reqJSON("/add_task",e)}function checkedIds(){var e=[];$("#fileTable .idCheck:checked").each(function(){e.push(parseInt($(this).val()))});return e}function RemoveDownload(){var o={id:checkedIds()};reqForm("/remove_task",o,function(){for(var e=0;e<o.id.length;e++){$("#id-"+o.id[e]).parent("tr").remove()}})}function StartDownload(){var e={id:checkedIds()};reqForm("/start_task",e)}function StopDownload(){var e={id:checkedIds()};reqForm("/stop_task",e)}function StartAllDownload(){reqJSON("/start_all_task")}function StopAllDownload(){reqJSON("/stop_all_task")}function OnChangeUrl(){var e=$("#url_id").val().split("?")[0].split("/").pop();$("#save_path_id").val(e);var o=e.split(".").pop();if(!o){$("#select-option-pipes").empty();$("#select-pipes").hide();return}o="."+o.toLowerCase();var n="";for(var a in pipes){var t=pipes[a];for(var r=0;r<t.Extensions.length;r++){var l=t.Extensions[r];if(l==o){n+='<div class="checkbox checkbox-primary checkbox-inline"><input type="checkbox" name="pipes[]" value="'+a+'" id="opt-pipes-'+a+'"><label for="opt-pipes-'+a+'">'+t.Label+"</label></div>"}}}if(n.length>0){$("#select-option-pipes").html(n);$("#select-pipes").show()}else{$("#select-option-pipes").empty();$("#select-pipes").hide()}}function loading(e){App.loading(e?"hide":"show")}$(function(){sockJSRead();$("body").on("click","#fileTable .allCheck",function(){$("#fileTable .idCheck").prop("checked",$(this).prop("checked"))});OnChangeUrl()});